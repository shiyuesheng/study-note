# JVM学习-内存结构-内存溢出与内存泄漏

## 内存溢出

- **java.lang.OutOfMemoryError : Java heap space**

  堆内存溢出，堆上分配不了内存了就会抛出。

  1. **原因推测：**有可能是对象真的太多了，到达了堆的最大上限；

     **解决思路：**Dump出堆转储快照，分析最多的对象是不是必须存活的，区分到底是内存泄漏、还是内存溢出。通过内存分析工具可以清晰的找到对象的创建地址，对应代码分析对象是否内存泄漏，内存泄漏就优化业务代码；

     若果对象是必须存活的那就查看堆上限是否还能上调，或者是业务代码时候能进一步优化，缩短对象的生命周期；

     一切手段都不行，运行这个服务就是要这么多内存，那就升级机器，换个更大的房子；或者进行业务拆分，减少单节点的压力。

  2. **原因推测：**也有可能没到上限，但是内存被别的占用了，无法分配对象；

     **解决思路：**这时就得从全局查看虚拟机运行配置，同物理机的配置是否契合。

     业务方面着重查看是否使用了NIO、Netty等IO框架，这部分会占用直接内存，如果没有为这部分消耗预留空间，就会出现OOM、或者节点长时间停顿、高延迟等问题。

- **java.lang.OutOfMemoryError : unable to create native thread**

  虚拟机栈内存溢出，无法创建线程了。

  1. **原因推测：**有可能是创建的线程数量已经超过了操作系统授予JVM进程的上限了？

     *这个我不是很确定是不是也会抛出这个异常，但这里记一下不能创建线程的一种情况，日后我了解到了相关知识后进行补充。*

  2. **原因推测：**有可能是JVM内存配置的不合理，导致内存被其他的堆、方法区、直接内存等等占用，没有留出足够的空间来给线程分配栈空间。

     **解决思路：**可以适当的减少堆内存的占用，腾出空间；也可以适当减少栈容量，使得每个线程的栈空间占用减少。这样双管齐下，可以创建更多的线程了。

     但是解决问题的同时需要反向思考下，是不是线程的使用有问题，线程真的是创建了太多了？最有效的管理线程的手段还是线程池

- **java.lang.OutOfMemoryError : PermGen space**

  方法区内存溢出，这是JDK8之前的错误信息

  1. 加载的类太多了

  2. 动态代理，字节码技术等加载的类太多了

     **解决思路：** -XX：MaxMetaspaceSize,调大一点；分析下是不是使用了某些有字节码加载类的框架。

     这里需要注意的是，JDK8之后字符串常量池移到了Java堆之中了，方法区溢出就不用考虑字符串常量池的问题了。同时JDK8 方法区的实现转移到了元数据空间，使用的本地内存。

     -XX:MaxMetaspaceSize 元空间最大值，默认是-1，即不限制，或者说只受限于本地内存大小。

     -XX:MetaspaceSize 元空间初始大小。

- java.lang.OutOfMemoryError

  有可能是直接内存溢出，无法向系统申请直接内存了。

  直接内存溢出明显的特征是Heap Dump文件中看不出什么异常，而且很小，而且程序中使用了DirectMemory（NIO），就可以往直接内存的使用考虑了。

## 内存泄漏

> 
>
> 参考资料：
>
> 1. 《深入理解Java虚拟机（第三版）》-周志明